# 이메일 인증 시스템 테스트 전략

## 개요
SendGrid 기반 이메일 인증 시스템을 위한 포괄적인 테스트 전략입니다. TDD 접근방식으로 실패하는 테스트를 먼저 작성하고, 테스트 피라미드 원칙을 적용하여 체계적으로 구성됩니다.

## 테스트 피라미드 구조

### Level 1: Unit Tests (70% of tests)
**대상**: 개별 함수, 컴포넌트, 서비스 단위
**목표**: 빠른 피드백, 높은 커버리지, 격리된 테스트

1. **EmailService 유닛 테스트**
   - `generateVerificationCode()` 함수 테스트
   - `sendVerificationCode()` 함수 테스트
   - `sendPasswordResetCode()` 함수 테스트
   - 이메일 템플릿 생성 테스트
   - SendGrid API 호출 모킹 테스트

2. **카운트다운 타이머 컴포넌트 테스트** (구현 예정)
   - 타이머 초기화 및 카운트다운 로직
   - 만료 시 콜백 실행
   - 타이머 리셋 기능
   - 시간 포맷팅 함수

3. **인증번호 검증 로직 테스트**
   - 코드 생성 알고리즘 (6자리 숫자)
   - 코드 만료 검증 (10분)
   - 코드 저장/조회/삭제 로직

### Level 2: Integration Tests (20% of tests)  
**대상**: API 엔드포인트, 서비스 간 상호작용
**목표**: 컴포넌트 간 협력 검증

1. **POST /api/auth/send-verification**
   - 유효한 이메일로 인증번호 발송
   - 잘못된 이메일 형식 처리
   - 중복 요청 처리
   - SendGrid 설정 없을 때 개발 모드 처리

2. **PUT /api/auth/send-verification**
   - 올바른 인증번호 검증
   - 잘못된 인증번호 처리
   - 만료된 인증번호 처리
   - 타입 불일치 처리 (signup vs reset)

3. **SignupForm 컴포넌트 통합**
   - API 호출 및 응답 처리
   - 상태 전이 (이메일 입력 → 인증번호 → 회원가입)
   - 에러 상태 관리 및 표시

### Level 3: E2E Tests (10% of tests)
**대상**: 전체 사용자 플로우
**목표**: 실제 사용자 시나리오 검증

1. **완전한 회원가입 플로우**
   - 이메일 입력 및 인증번호 요청
   - 인증번호 입력 및 검증
   - 개인정보 입력 및 회원가입 완료
   - 대시보드 리디렉션 확인

## 질품 게이트 및 커버리지 요구사항

### 커버리지 임계값
- **Unit Tests**: 90% 이상 (핵심 로직)
- **Integration Tests**: 85% 이상 (API 엔드포인트)
- **E2E Tests**: 100% (중요 사용자 경로)
- **전체 모듈**: 80% 이상

### 품질 게이트
1. **Critical Path Coverage**: 100%
2. **Mutation Testing Score**: 75% 이상
3. **Flaky Test Rate**: 1% 미만
4. **Test Execution Time**: 30초 이내
5. **Code Duplication**: 5% 미만

### TDD Red-Green-Refactor 사이클
1. **Red**: 실패하는 테스트 먼저 작성
2. **Green**: 테스트를 통과하는 최소한의 코드 작성
3. **Refactor**: 코드 품질 향상 및 중복 제거

## Edge Case 및 예외 상황

### 네트워크 실패 시나리오
- SendGrid API 호출 실패
- 타임아웃 처리 (30초)
- 재시도 로직 (최대 3회)
- 네트워크 연결 끊김

### 인증번호 관련 Edge Cases
- 만료된 코드 입력
- 잘못된 코드 5회 연속 입력
- 중복 요청 (1분 내 재요청 제한)
- 메모리 스토어 용량 초과

### 레이트 리미팅
- IP별 시간당 요청 제한 (10회)
- 이메일별 일일 요청 제한 (5회)
- 429 응답 처리 및 대기시간 표시

## 테스트 데이터 관리

### 테스트용 이메일 주소
- 유효한 이메일: `test@example.com`
- 잘못된 형식: `invalid-email`, `@domain.com`
- 블랙리스트 이메일: `blocked@spam.com`

### 모킹 전략
- SendGrid API 완전 모킹
- 네트워크 지연 시뮬레이션 (100-500ms)
- 에러율 시뮬레이션 (5%)
- 개발 모드 vs 프로덕션 모드 분리

## 테스트 환경 설정

### MSW (Mock Service Worker) 핸들러
- 인증번호 발송 API 모킹
- 인증번호 검증 API 모킹
- 에러 시나리오별 핸들러
- 레이트 리미팅 시뮬레이션

### 테스트 유틸리티
- 이메일 인증 플로우 헬퍼 함수
- 타이머 모킹 유틸리티
- API 응답 데이터 팩토리
- 테스트 클린업 함수

## 성공 기준

### 기능적 요구사항
- [ ] 6자리 숫자 인증번호 생성
- [ ] 10분 만료 시간 정확성
- [ ] SendGrid 이메일 발송 성공
- [ ] 인증번호 검증 정확성
- [ ] 에러 메시지 사용자 친화성

### 비기능적 요구사항
- [ ] API 응답시간 200ms 이내
- [ ] 이메일 발송 5초 이내
- [ ] 메모리 사용량 10MB 이내
- [ ] 동시 요청 100개 처리 가능

### 보안 요구사항
- [ ] 인증번호 암호화 저장
- [ ] CSRF 토큰 검증
- [ ] 레이트 리미팅 적용
- [ ] 민감 정보 로그 제외

## 테스트 실행 전략

### 병렬 실행
- 유닛 테스트: 병렬 실행 (4 threads)
- 통합 테스트: 순차 실행 (DB 의존성)
- E2E 테스트: 단일 스레드

### CI/CD 통합
- PR 생성 시 전체 테스트 실행
- main 브랜치 merge 시 회귀 테스트
- 야간 빌드 시 성능 테스트
- 배포 전 smoke 테스트

## 메트릭 및 모니터링

### 테스트 메트릭
- 테스트 실행 시간 추이
- 커버리지 변화 추적
- 실패율 통계
- Flaky 테스트 식별

### 품질 메트릭
- 코드 복잡도 (Cyclomatic Complexity)
- 기술 부채 점수
- 의존성 분석
- 보안 취약점 스캔

---

**작성일**: 2025-08-27
**버전**: 1.0
**작성자**: QA Lead Grace
**검토자**: Chief Architect Arthur