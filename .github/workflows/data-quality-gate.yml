# ë°ì´í„° í’ˆì§ˆ ê²Œì´íŠ¸ ì›Œí¬í”Œë¡œìš°
# CLAUDE.md Part 4.1 - í’ˆì§ˆ ê²Œì´íŠ¸ & CI ì¤€ìˆ˜
# Daniel's Data Lead Standards - ê³„ì•½ ê¸°ë°˜ ê²€ì¦, ë°°í¬ ì°¨ë‹¨

name: Data Quality Gate

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'package.json'
      - '.github/workflows/data-quality-gate.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run quality gate'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      dry_run:
        description: 'Run without making changes'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.x'

jobs:
  data-quality-gate:
    name: Data Quality Validation
    runs-on: ubuntu-latest
    
    # í™˜ê²½ë³„ ì„¤ì •
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    
    outputs:
      quality-score: ${{ steps.quality-gate.outputs.quality-score }}
      gate-status: ${{ steps.quality-gate.outputs.gate-status }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (í’ˆì§ˆ íŠ¸ë Œë“œ ë¶„ì„ìš©)

      - name: ğŸ“¦ Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'vridge-web/pnpm-lock.yaml'

      - name: ğŸ“¥ Install dependencies
        working-directory: vridge-web
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build TypeScript
        working-directory: vridge-web
        run: |
          pnpm build:types
          pnpm tsc --noEmit

      - name: ğŸ§ª Run unit tests for data integrity
        working-directory: vridge-web
        run: |
          pnpm test src/shared/lib/data-integrity-checker.test.ts --coverage
          pnpm test src/shared/lib/data-quality-pipeline.test.ts --coverage

      - name: ğŸ” Execute Data Quality Gate
        id: quality-gate
        working-directory: vridge-web
        env:
          NODE_ENV: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          # í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤í–‰
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ” Running data quality gate (DRY RUN mode)"
            node scripts/data-quality-gate.js --env=$NODE_ENV --dry-run --verbose
          else
            echo "ğŸ” Running data quality gate"
            node scripts/data-quality-gate.js --env=$NODE_ENV --verbose
          fi
          
          # ê²°ê³¼ íŒŒì‹± ë° ì¶œë ¥ ì„¤ì •
          quality_score=$(grep -o 'Quality Score: [0-9.]*%' quality-gate.log | grep -o '[0-9.]*' || echo "0")
          gate_status=$(grep -o 'Quality Gate [A-Z]*' quality-gate.log | awk '{print $3}' || echo "UNKNOWN")
          
          echo "quality-score=$quality_score" >> $GITHUB_OUTPUT
          echo "gate-status=$gate_status" >> $GITHUB_OUTPUT
          
          # GitHub í™˜ê²½ìœ¼ë¡œ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
          echo "QUALITY_SCORE=$quality_score" >> $GITHUB_ENV
          echo "GATE_STATUS=$gate_status" >> $GITHUB_ENV

      - name: ğŸ“Š Generate Quality Report
        if: always()
        working-directory: vridge-web
        run: |
          # í’ˆì§ˆ ë³´ê³ ì„œ ìƒì„±
          mkdir -p reports
          
          # ê¸°ë³¸ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
          echo "{
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"workflow_run_id\": \"${{ github.run_id }}\",
            \"commit_sha\": \"${{ github.sha }}\",
            \"branch\": \"${{ github.ref_name }}\",
            \"environment\": \"${{ env.NODE_ENV }}\",
            \"quality_score\": ${{ env.QUALITY_SCORE || 0 }},
            \"gate_status\": \"${{ env.GATE_STATUS }}\",
            \"dry_run\": ${{ github.event.inputs.dry_run || false }}
          }" > reports/quality-summary.json
          
          # ìƒì„¸ ë³´ê³ ì„œ ìƒì„± (ì‹¤ì œë¡œëŠ” data-quality-gate.jsì—ì„œ ìƒì„±)
          if [ -f "reports/data-quality-*.json" ]; then
            echo "ğŸ“Š Quality report files found"
            ls -la reports/
          fi

      - name: ğŸ“¤ Upload Quality Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: data-quality-report-${{ env.NODE_ENV }}-${{ github.run_id }}
          path: |
            vridge-web/reports/
          retention-days: 30

      - name: ğŸ’¬ Comment PR with Quality Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const qualityScore = '${{ env.QUALITY_SCORE }}' || '0';
            const gateStatus = '${{ env.GATE_STATUS }}' || 'UNKNOWN';
            const isDryRun = ${{ github.event.inputs.dry_run || false }};
            
            const statusEmoji = gateStatus === 'PASSED' ? 'âœ…' : 'âŒ';
            const scoreEmoji = parseFloat(qualityScore) >= 90 ? 'ğŸŸ¢' : parseFloat(qualityScore) >= 70 ? 'ğŸŸ¡' : 'ğŸ”´';
            
            const body = `## ${statusEmoji} Data Quality Gate Results
            
            ${isDryRun ? 'ğŸ§ª **DRY RUN MODE**' : ''}
            
            | Metric | Value | Status |
            |--------|-------|---------|
            | Quality Score | ${scoreEmoji} ${qualityScore}% | ${gateStatus} |
            | Environment | ${{ env.NODE_ENV }} | |
            | Commit | \`${{ github.sha }}\` | |
            
            ### ğŸ“Š Details
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Quality Report**: Available in workflow artifacts
            
            ${gateStatus !== 'PASSED' ? 'âš ï¸ **Quality gate failed - please review the issues before merging**' : 'ğŸ‰ **All quality checks passed**'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: âš ï¸ Quality Gate Status Check
        if: always()
        run: |
          if [ "${{ env.GATE_STATUS }}" = "PASSED" ]; then
            echo "âœ… Data quality gate passed successfully"
            exit 0
          elif [ "${{ env.GATE_STATUS }}" = "FAILED" ] && [ "${{ env.NODE_ENV }}" = "production" ]; then
            echo "âŒ Data quality gate failed in production environment"
            echo "ğŸš« Blocking deployment due to quality gate failure"
            exit 1
          elif [ "${{ env.GATE_STATUS }}" = "FAILED" ]; then
            echo "âš ï¸ Data quality gate failed but not blocking in ${{ env.NODE_ENV }} environment"
            exit 0
          else
            echo "â“ Unknown quality gate status: ${{ env.GATE_STATUS }}"
            exit 1
          fi

  # í’ˆì§ˆ íŠ¸ë Œë“œ ë¶„ì„ (ì„ íƒì )
  quality-trend-analysis:
    name: Quality Trend Analysis
    runs-on: ubuntu-latest
    needs: [data-quality-gate]
    if: github.ref == 'refs/heads/main' && always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # ìµœê·¼ 50ê°œ ì»¤ë°‹ íˆìŠ¤í† ë¦¬

      - name: ğŸ“Š Download Quality Report
        uses: actions/download-artifact@v3
        with:
          name: data-quality-report-${{ needs.data-quality-gate.outputs.environment || 'staging' }}-${{ github.run_id }}
          path: ./reports/

      - name: ğŸ“ˆ Analyze Quality Trends
        run: |
          echo "ğŸ“ˆ Quality Trend Analysis"
          echo "Current Quality Score: ${{ needs.data-quality-gate.outputs.quality-score }}%"
          echo "Current Gate Status: ${{ needs.data-quality-gate.outputs.gate-status }}"
          
          # ì‹¤ì œë¡œëŠ” ê³¼ê±° í’ˆì§ˆ ë°ì´í„°ì™€ ë¹„êµí•˜ì—¬ íŠ¸ë Œë“œ ë¶„ì„
          # ì˜ˆ: í’ˆì§ˆ ì ìˆ˜ í•˜ë½ ì‹œ ì•Œë¦¼, ê°œì„  ì¶”ì²œ ë“±
          
          current_score=${{ needs.data-quality-gate.outputs.quality-score }}
          if [ "$current_score" -lt "80" ]; then
            echo "âš ï¸ Quality score is below 80% - consider immediate improvement actions"
          fi

      - name: ğŸ”” Notify Quality Degradation
        if: needs.data-quality-gate.outputs.quality-score < 80
        run: |
          echo "ğŸš¨ Quality degradation detected!"
          echo "Recommended actions:"
          echo "  1. Review data integrity issues"
          echo "  2. Check rating-role mapping consistency"  
          echo "  3. Clean up orphaned records"
          echo "  4. Update data validation rules"

  # Slack ì•Œë¦¼ (ì„ íƒì )
  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [data-quality-gate]
    if: always() && (github.ref == 'refs/heads/main' || needs.data-quality-gate.outputs.gate-status == 'FAILED')
    
    steps:
      - name: ğŸ”” Send Slack notification
        # uses: 8398a7/action-slack@v3
        # with:
        #   status: ${{ needs.data-quality-gate.outputs.gate-status }}
        #   channel: '#data-quality'
        #   webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          echo "ğŸ”” Would send Slack notification:"
          echo "Status: ${{ needs.data-quality-gate.outputs.gate-status }}"
          echo "Quality Score: ${{ needs.data-quality-gate.outputs.quality-score }}%"
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"