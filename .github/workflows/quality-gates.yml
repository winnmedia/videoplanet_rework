name: í’ˆì§ˆ ê²Œì´íŠ¸ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # 1ë‹¨ê³„: ê¸°ë³¸ í’ˆì§ˆ ê²€ì‚¬
  lint-and-format:
    name: ë¦°íŠ¸ ë° í¬ë§· ê²€ì‚¬
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: TypeScript íƒ€ì… ê²€ì‚¬
        run: npx tsc --noEmit --skipLibCheck
        
      - name: ESLint ê²€ì‚¬
        run: pnpm lint
        
      - name: Prettier í¬ë§· ê²€ì‚¬
        run: pnpm format:check
        
      - name: ìˆœí™˜ ì˜ì¡´ì„± ê²€ì‚¬
        run: npx madge --circular --extensions ts,tsx src/

  # 2ë‹¨ê³„: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° ì»¤ë²„ë¦¬ì§€
  unit-tests:
    name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° ì»¤ë²„ë¦¬ì§€
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì»¤ë²„ë¦¬ì§€ í¬í•¨)
        run: pnpm test:coverage
        
      - name: ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì¦
        run: |
          node -e "
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
          const { lines, functions, branches, statements } = coverage.total;
          
          const failures = [];
          if (lines.pct < 80) failures.push(\`Lines: \${lines.pct}% < 80%\`);
          if (functions.pct < 80) failures.push(\`Functions: \${functions.pct}% < 80%\`);
          if (branches.pct < 80) failures.push(\`Branches: \${branches.pct}% < 80%\`);
          if (statements.pct < 80) failures.push(\`Statements: \${statements.pct}% < 80%\`);
          
          if (failures.length > 0) {
            console.error('âŒ ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ë¯¸ë‹¬:');
            failures.forEach(f => console.error(\`  \${f}\`));
            process.exit(1);
          }
          console.log('âœ… ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ í†µê³¼');
          "
          
      - name: ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: true

  # 3ë‹¨ê³„: Mutation Testing (í•µì‹¬ ì½”ë“œë§Œ)
  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'pull_request'
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ë³€ê²½ íŒŒì¼ ê°ì§€ë¥¼ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”
          
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E "src/(entities|features).*\.(ts|tsx)$" | grep -v "\.test\." | head -10)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
      - name: Mutation Testing ì‹¤í–‰ (ë³€ê²½ëœ íŒŒì¼ë§Œ)
        if: steps.changed-files.outputs.changed_files != ''
        run: |
          # ë³€ê²½ëœ íŒŒì¼ë§Œ ëŒ€ìƒìœ¼ë¡œ mutation testing ì‹¤í–‰
          npx stryker run --mutate "${{ steps.changed-files.outputs.changed_files }}"
          
      - name: Mutation ê²°ê³¼ ì—…ë¡œë“œ
        if: steps.changed-files.outputs.changed_files != ''
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: reports/mutation/

  # 4ë‹¨ê³„: ì„±ëŠ¥ ë° ë²ˆë“¤ ê²€ì‚¬
  performance-tests:
    name: ì„±ëŠ¥ ë° ë²ˆë“¤ ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: pnpm build
        
      - name: ë²ˆë“¤ ì‚¬ì´ì¦ˆ ê²€ì‚¬
        run: npx size-limit
        
      - name: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
        run: node scripts/performance-monitor.js
        
      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: reports/performance/

  # 5ë‹¨ê³„: Contract Testing
  contract-tests:
    name: API ê³„ì•½ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: Pact í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: pnpm test -- --testPathPattern="pact-contract.test.ts"
        
      - name: Pact íŒŒì¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: pact-contracts
          path: pacts/

  # 6ë‹¨ê³„: E2E í…ŒìŠ¤íŠ¸
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [unit-tests, performance-tests]
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: pnpm build
        
      - name: Cypress E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        uses: cypress-io/github-action@v6
        with:
          start: pnpm start
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          record: true
          parallel: true
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Percy ì‹œê°ì  í…ŒìŠ¤íŠ¸
        if: github.event_name == 'pull_request'
        run: npx percy exec -- cypress run
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          
      - name: E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          
      - name: E2E ë¹„ë””ì˜¤ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos

  # 7ë‹¨ê³„: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
  accessibility-tests:
    name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: pnpm build
        
      - name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          pnpm start &
          sleep 10
          pnpm accessibility
          
      - name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ (Jest)
        run: pnpm test -- --testPathPattern="accessibility.test.ts"

  # 8ë‹¨ê³„: ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    name: ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬
        run: pnpm audit --audit-level moderate
        
      - name: CodeQL ë¶„ì„
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: CodeQL ìë™ ë¹Œë“œ
        uses: github/codeql-action/autobuild@v3
        
      - name: CodeQL ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v3

  # 9ë‹¨ê³„: í’ˆì§ˆ ê²Œì´íŠ¸ ì¢…í•© í‰ê°€
  quality-gate-final:
    name: ìµœì¢… í’ˆì§ˆ ê²Œì´íŠ¸
    runs-on: ubuntu-latest
    needs: [unit-tests, performance-tests, contract-tests, e2e-tests, accessibility-tests, security-scan]
    if: always()
    steps:
      - name: í’ˆì§ˆ ê²Œì´íŠ¸ ê²°ê³¼ ìˆ˜ì§‘
        run: |
          echo "ğŸ” í’ˆì§ˆ ê²Œì´íŠ¸ ê²°ê³¼ ì¢…í•©..."
          
          # ê° ì‘ì—…ì˜ ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ í™•ì¸
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "âŒ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi
          
          if [ "${{ needs.performance-tests.result }}" != "success" ]; then
            echo "âŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi
          
          if [ "${{ needs.contract-tests.result }}" != "success" ]; then
            echo "âŒ ê³„ì•½ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨" 
            exit 1
          fi
          
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "âŒ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi
          
          if [ "${{ needs.accessibility-tests.result }}" != "success" ]; then
            echo "âŒ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi
          
          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨"
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼"
          
      - name: ë°°í¬ ìŠ¹ì¸
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          echo "ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¹ì¸ë¨"
          echo "DEPLOY_APPROVED=true" >> $GITHUB_ENV

# ë³„ë„ ì›Œí¬í”Œë¡œìš°: ì•¼ê°„ ì „ì²´ í’ˆì§ˆ ê²€ì‚¬
  nightly-full-scan:
    name: ì•¼ê°„ ì „ì²´ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: ì „ì²´ Mutation Testing
        run: npx stryker run
        
      - name: ì„±ëŠ¥ íšŒê·€ í…ŒìŠ¤íŠ¸
        run: |
          pnpm build
          node scripts/performance-monitor.js
          
      - name: ì „ì²´ ì ‘ê·¼ì„± ìŠ¤ìº”
        run: |
          pnpm start &
          sleep 10
          # ì£¼ìš” í˜ì´ì§€ ì ‘ê·¼ì„± ìŠ¤ìº”
          for page in / /auth/login /auth/signup /dashboard /video/upload; do
            pnpm accessibility "$page"
          done
          
      - name: ë³´ì•ˆ ì‹¬í™” ìŠ¤ìº”
        run: |
          pnpm audit --audit-level low
          # ì¶”ê°€ ë³´ì•ˆ ë„êµ¬ ì‹¤í–‰ ê°€ëŠ¥
          
      - name: í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
        run: node scripts/quality-dashboard.js
        
      - name: ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: nightly-quality-report
          path: reports/