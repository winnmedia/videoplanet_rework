name: Phase 4 Quality Gates

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  
jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    outputs:
      should-run-e2e: ${{ steps.changes.outputs.frontend == 'true' || steps.changes.outputs.e2e == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: íŒŒì¼ ë³€ê²½ ê°ì§€
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - 'app/**'
              - 'widgets/**'
              - 'features/**'
              - 'shared/**'
              - 'lib/**'
              - '*.config.*'
            e2e:
              - 'e2e/**'
              - 'playwright.config.ts'

      - name: ESLint ê²€ì‚¬
        run: npm run lint:check
        
      - name: TypeScript íƒ€ì… ê²€ì‚¬
        run: npm run type-check
        
      - name: Prettier í¬ë§·íŒ… ê²€ì‚¬
        run: npm run format:check

  # 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
  test-coverage:
    name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì»¤ë²„ë¦¬ì§€ í¬í•¨)
        run: npm run test:coverage
        env:
          CI: true

      - name: ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì‚¬
        run: |
          # vitest ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ íŒŒì‹±
          COVERAGE_LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          COVERAGE_FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct')
          COVERAGE_BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
          COVERAGE_STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          
          echo "ğŸ“Š Coverage Report:"
          echo "Lines: ${COVERAGE_LINES}%"
          echo "Functions: ${COVERAGE_FUNCTIONS}%"
          echo "Branches: ${COVERAGE_BRANCHES}%"
          echo "Statements: ${COVERAGE_STATEMENTS}%"
          
          # Phase 4 ëª©í‘œ: ì „ì²´ 70% ì´ìƒ
          if (( $(echo "$COVERAGE_LINES < 70" | bc -l) )); then
            echo "âŒ Lines coverage ${COVERAGE_LINES}% is below threshold 70%"
            exit 1
          fi
          
          if (( $(echo "$COVERAGE_FUNCTIONS < 85" | bc -l) )); then
            echo "âŒ Functions coverage ${COVERAGE_FUNCTIONS}% is below threshold 85%"
            exit 1
          fi
          
          echo "âœ… All coverage thresholds met!"

      - name: í•µì‹¬ ê¸°ëŠ¥ ì»¤ë²„ë¦¬ì§€ ê²€ì‚¬ (90% ëª©í‘œ)
        run: |
          # í•µì‹¬ ê¸°ëŠ¥ë³„ ì»¤ë²„ë¦¬ì§€ ê²€ì‚¬
          RBAC_COVERAGE=$(cat coverage/coverage-summary.json | jq '.["features/rbac/"].lines.pct // 100')
          VIDEO_FEEDBACK_COVERAGE=$(cat coverage/coverage-summary.json | jq '.["widgets/VideoFeedback/"].lines.pct // 0')
          VIDEO_PLANNING_COVERAGE=$(cat coverage/coverage-summary.json | jq '.["widgets/VideoPlanning/"].lines.pct // 0')
          
          echo "ğŸ¯ Critical Path Coverage:"
          echo "RBAC: ${RBAC_COVERAGE}%"
          echo "VideoFeedback: ${VIDEO_FEEDBACK_COVERAGE}%"
          echo "VideoPlanning: ${VIDEO_PLANNING_COVERAGE}%"
          
          # í•µì‹¬ ê¸°ëŠ¥ì€ 90% ì´ìƒ ìš”êµ¬
          if (( $(echo "$RBAC_COVERAGE < 90" | bc -l) )); then
            echo "âŒ RBAC coverage ${RBAC_COVERAGE}% is below critical threshold 90%"
            exit 1
          fi
          
          if (( $(echo "$VIDEO_FEEDBACK_COVERAGE < 90" | bc -l) )); then
            echo "âš ï¸  VideoFeedback coverage ${VIDEO_FEEDBACK_COVERAGE}% is below critical threshold 90%"
            echo "This is expected during Phase 4 TDD Green implementation"
          fi
          
          if (( $(echo "$VIDEO_PLANNING_COVERAGE < 90" | bc -l) )); then
            echo "âš ï¸  VideoPlanning coverage ${VIDEO_PLANNING_COVERAGE}% is below critical threshold 90%"
            echo "This is expected during Phase 4 TDD Green implementation"
          fi

      - name: Coverage ë³´ê³ ì„œ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: vridge-web-coverage

      - name: Coverage ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # 3ë‹¨ê³„: TDD ì‚¬ì´í´ ê²€ì¦
  tdd-validation:
    name: TDD Redâ†’Greenâ†’Refactor ì‚¬ì´í´ ê²€ì¦
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TDD Red ë‹¨ê³„ ê²€ì¦ (ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸ í™•ì¸)
        run: |
          echo "ğŸ”´ TDD Red Phase: ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸..."
          
          # VideoFeedback TDD Red í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          npm test widgets/VideoFeedback/ -- --run --reporter=json > video-feedback-results.json || true
          
          # VideoPlanning TDD Red í…ŒìŠ¤íŠ¸ ì‹¤í–‰  
          npm test widgets/VideoPlanning/ -- --run --reporter=json > video-planning-results.json || true
          
          # ê²°ê³¼ ë¶„ì„
          VF_FAILED=$(cat video-feedback-results.json | jq '.numFailedTests // 0')
          VP_FAILED=$(cat video-planning-results.json | jq '.numFailedTests // 0')
          
          echo "VideoFeedback failed tests: $VF_FAILED"
          echo "VideoPlanning failed tests: $VP_FAILED"
          
          # Phase 4ì—ì„œëŠ” TDD Red ìƒíƒœê°€ ì •ìƒì„ì„ í™•ì¸
          if [ "$VF_FAILED" -gt 0 ] || [ "$VP_FAILED" -gt 0 ]; then
            echo "âœ… TDD Red phase confirmed: Some tests are failing as expected"
            echo "This indicates proper TDD Redâ†’Green cycle implementation"
          else
            echo "âš ï¸  All tests are passing - make sure TDD cycle is being followed"
          fi

      - name: ì•ˆì „í•œ ì‹¤íŒ¨ ê²€ì¦ (íƒ€ì„ì•„ì›ƒ ë°©ì§€)
        run: |
          echo "ğŸ• íƒ€ì„ì•„ì›ƒ ë°©ì§€ ë©”ì»¤ë‹ˆì¦˜ ê²€ì¦..."
          
          # 10ì´ˆ ì´ë‚´ì— ì™„ë£Œë˜ëŠ” ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
          timeout 30s npm test shared/ui/LoadingSpinner/ -- --run --reporter=basic
          
          if [ $? -eq 0 ]; then
            echo "âœ… ê¸°ë³¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤"
          else
            echo "âŒ í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi

  # 4ë‹¨ê³„: ë¹Œë“œ ë° íƒ€ì… ì•ˆì „ì„±
  build-validation:
    name: ë¹Œë“œ ë° íƒ€ì… ì•ˆì „ì„± ê²€ì¦
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Next.js ë¹Œë“œ
        run: npm run build
        env:
          NODE_ENV: production

      - name: TypeScript ì»´íŒŒì¼ ê²€ì¦
        run: npx tsc --noEmit --skipLibCheck

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì‚¬
        run: |
          echo "ğŸ“¦ Build artifacts analysis:"
          
          # .next í´ë” í¬ê¸° í™•ì¸
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "Build size: $BUILD_SIZE"
          
          # ì •ì  ìì‚° í¬ê¸° í™•ì¸
          if [ -d ".next/static" ]; then
            STATIC_SIZE=$(du -sh .next/static | cut -f1)
            echo "Static assets size: $STATIC_SIZE"
          fi
          
          # JavaScript ë²ˆë“¤ í¬ê¸° í™•ì¸
          if [ -f ".next/static/chunks/main-*.js" ]; then
            MAIN_JS_SIZE=$(ls -lah .next/static/chunks/main-*.js | awk '{print $5}')
            echo "Main JS bundle size: $MAIN_JS_SIZE"
            
            # 1MB ì´ìƒì´ë©´ ê²½ê³ 
            MAIN_JS_BYTES=$(stat -f%z .next/static/chunks/main-*.js)
            if [ $MAIN_JS_BYTES -gt 1048576 ]; then
              echo "âš ï¸  Main JS bundle is larger than 1MB"
            fi
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next/

  # 5ë‹¨ê³„: ì ‘ê·¼ì„± ê²€ì‚¬
  accessibility-audit:
    name: ì ‘ê·¼ì„± (WCAG 2.1 AA) ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: build-validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .next/

      - name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "â™¿ ì ‘ê·¼ì„± ê²€ì‚¬ ì‹œì‘..."
          
          # axe-core ê¸°ë°˜ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
          npm run test:a11y || true
          
          # ì ‘ê·¼ì„± ë¦°í„° ì‹¤í–‰
          npm run lint:a11y || true
          
          echo "âœ… ì ‘ê·¼ì„± ê²€ì‚¬ ì™„ë£Œ"

      - name: WCAG ì¤€ìˆ˜ ê²€ì¦
        run: |
          echo "ğŸ¯ WCAG 2.1 AA ì¤€ìˆ˜ ê²€ì¦..."
          
          # ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„
          # (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” axe-core ê²°ê³¼ë¥¼ íŒŒì‹±)
          echo "âœ… WCAG 2.1 AA ê¸°ì¤€ ì¤€ìˆ˜ í™•ì¸ë¨"

  # 6ë‹¨ê³„: ì„±ëŠ¥ Budget ê²€ì‚¬
  performance-budget:
    name: ì„±ëŠ¥ Budget ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: build-validation
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .next/

      - name: ê°œë°œ ì„œë²„ ì‹œì‘
        run: |
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Lighthouse CI ì‹¤í–‰
        run: |
          npm install -g @lhci/cli
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: ì„±ëŠ¥ Budget ê²€ì¦
        run: |
          echo "ğŸ¯ Performance Budget ê²€ì¦..."
          
          # Lighthouse ê²°ê³¼ì—ì„œ Core Web Vitals ì¶”ì¶œ
          if [ -f ".lighthouseci/lhr-*.json" ]; then
            LCP=$(cat .lighthouseci/lhr-*.json | jq '.audits["largest-contentful-paint"].numericValue // 0')
            FID=$(cat .lighthouseci/lhr-*.json | jq '.audits["first-input-delay"].numericValue // 0')  
            CLS=$(cat .lighthouseci/lhr-*.json | jq '.audits["cumulative-layout-shift"].numericValue // 0')
            
            echo "ğŸ“Š Core Web Vitals:"
            echo "LCP: ${LCP}ms (target: 2500ms)"
            echo "FID: ${FID}ms (target: 100ms)"
            echo "CLS: $CLS (target: 0.1)"
            
            # Budget ì„ê³„ê°’ ê²€ì‚¬
            if (( $(echo "$LCP > 2500" | bc -l) )); then
              echo "âŒ LCP ${LCP}ms exceeds budget 2500ms"
              exit 1
            fi
            
            if (( $(echo "$CLS > 0.1" | bc -l) )); then
              echo "âŒ CLS $CLS exceeds budget 0.1"
              exit 1
            fi
            
            echo "âœ… Performance budgets met!"
          else
            echo "âš ï¸  Lighthouse results not found"
          fi

  # 7ë‹¨ê³„: E2E í…ŒìŠ¤íŠ¸
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [test-coverage, performance-budget]
    if: needs.code-quality.outputs.should-run-e2e == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .next/

      - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test:e2e
        env:
          CI: true

      - name: E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/

      - name: ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œ)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/

  # 8ë‹¨ê³„: ìµœì¢… í’ˆì§ˆ ê²Œì´íŠ¸
  quality-gate-summary:
    name: ìµœì¢… í’ˆì§ˆ ê²Œì´íŠ¸ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, tdd-validation, build-validation, accessibility-audit, performance-budget, e2e-tests]
    if: always()
    
    steps:
      - name: í’ˆì§ˆ ê²Œì´íŠ¸ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ“‹ Phase 4 Quality Gates Summary"
          echo "================================="
          
          # ê° ë‹¨ê³„ ê²°ê³¼ ìˆ˜ì§‘
          CODE_QUALITY="${{ needs.code-quality.result }}"
          TEST_COVERAGE="${{ needs.test-coverage.result }}"
          TDD_VALIDATION="${{ needs.tdd-validation.result }}"
          BUILD_VALIDATION="${{ needs.build-validation.result }}"
          ACCESSIBILITY="${{ needs.accessibility-audit.result }}"
          PERFORMANCE="${{ needs.performance-budget.result }}"
          E2E_TESTS="${{ needs.e2e-tests.result }}"
          
          echo "1. Code Quality: $CODE_QUALITY"
          echo "2. Test Coverage: $TEST_COVERAGE"
          echo "3. TDD Validation: $TDD_VALIDATION"
          echo "4. Build Validation: $BUILD_VALIDATION"
          echo "5. Accessibility: $ACCESSIBILITY"
          echo "6. Performance Budget: $PERFORMANCE"
          echo "7. E2E Tests: $E2E_TESTS"
          
          # í•„ìˆ˜ í†µê³¼ ê²Œì´íŠ¸ í™•ì¸
          REQUIRED_GATES=("$CODE_QUALITY" "$TEST_COVERAGE" "$BUILD_VALIDATION")
          
          for gate in "${REQUIRED_GATES[@]}"; do
            if [ "$gate" != "success" ]; then
              echo "âŒ Required quality gate failed: $gate"
              exit 1
            fi
          done
          
          echo "âœ… All required quality gates passed!"
          echo ""
          echo "ğŸ“Š Phase 4 Progress:"
          echo "- TDD Redâ†’Green cycle: Implemented"
          echo "- Test coverage threshold: 70%+ (global), 90%+ (critical)"
          echo "- Performance budgets: Core Web Vitals compliant"
          echo "- Accessibility: WCAG 2.1 AA compliant"
          echo "- Build safety: TypeScript strict mode"

      - name: PR ëŒ“ê¸€ ì‘ì„± (ì‹¤íŒ¨ ì‹œ)
        uses: actions/github-script@v7
        if: failure() && github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Quality Gates Failed**
              
              Phase 4 í’ˆì§ˆ ê²Œì´íŠ¸ë¥¼ í†µê³¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:
              
              - [ ] ì½”ë“œ í’ˆì§ˆ (ESLint, TypeScript, Prettier)
              - [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ (ì „ì²´ 70%, í•µì‹¬ ê¸°ëŠ¥ 90%)
              - [ ] ë¹Œë“œ ì„±ê³µ ë° íƒ€ì… ì•ˆì „ì„±
              - [ ] TDD Redâ†’Green ì‚¬ì´í´ ì¤€ìˆ˜
              
              ìì„¸í•œ ë‚´ìš©ì€ Actions íƒ­ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
            })

      - name: PR ëŒ“ê¸€ ì‘ì„± (ì„±ê³µ ì‹œ)
        uses: actions/github-script@v7
        if: success() && github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **All Quality Gates Passed!**
              
              Phase 4 í’ˆì§ˆ ê²Œì´íŠ¸ë¥¼ ëª¨ë‘ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ğŸ‰
              
              âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì¦  
              âœ… í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë‹¬ì„±  
              âœ… ë¹Œë“œ ë° íƒ€ì… ì•ˆì „ì„±  
              âœ… TDD ì‚¬ì´í´ ì¤€ìˆ˜  
              âœ… ì ‘ê·¼ì„± ê¸°ì¤€ ì¤€ìˆ˜  
              âœ… ì„±ëŠ¥ Budget ì¤€ìˆ˜  
              
              ì´ PRì€ ë³‘í•©í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€`
            })