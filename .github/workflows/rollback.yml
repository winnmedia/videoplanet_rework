name: ğŸ”„ ìë™ ë¡¤ë°± ì‹œìŠ¤í…œ

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'ë¡¤ë°±í•  í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      rollback_to:
        description: 'ë¡¤ë°±í•  ë²„ì „ (ì˜ˆ: v2.0.1)'
        required: true
        type: string
      reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        type: string
      skip_validation:
        description: 'ê²€ì¦ ìŠ¤í‚µ (ê¸´ê¸‰ ë¡¤ë°±)'
        required: false
        default: false
        type: boolean
  
  # ìë™ íŠ¸ë¦¬ê±° (ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
  workflow_call:
    inputs:
      target_environment:
        required: true
        type: string
      rollback_to:
        required: true
        type: string
      reason:
        required: true
        type: string
      skip_validation:
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/vridge-web

permissions:
  contents: read
  packages: read
  deployments: write
  checks: write
  issues: write

jobs:
  # ========================================
  # Stage 1: ë¡¤ë°± ê²€ì¦ ë° ì¤€ë¹„
  # ========================================
  rollback-validation:
    name: ğŸ” ë¡¤ë°± ê²€ì¦ ë° ì¤€ë¹„
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.current.outputs.version }}
      target-version: ${{ steps.target.outputs.version }}
      rollback-approved: ${{ steps.approval.outputs.approved }}
      environment: ${{ inputs.target_environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: í˜„ì¬ ë°°í¬ ë²„ì „ í™•ì¸
        id: current
        run: |
          ENVIRONMENT="${{ inputs.target_environment }}"
          
          # í™˜ê²½ë³„ í˜„ì¬ ë²„ì „ í™•ì¸
          if [[ "$ENVIRONMENT" == "production" ]]; then
            CURRENT_VERSION=$(curl -s https://vridge.vlanet.net/api/version | jq -r '.version' || echo "unknown")
          else
            CURRENT_VERSION=$(curl -s https://staging.vridge.vlanet.net/api/version | jq -r '.version' || echo "unknown")
          fi
          
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Current version in $ENVIRONMENT: $CURRENT_VERSION"

      - name: ë¡¤ë°± ëŒ€ìƒ ë²„ì „ ê²€ì¦
        id: target
        run: |
          TARGET_VERSION="${{ inputs.rollback_to }}"
          
          # Git íƒœê·¸ ì¡´ì¬ í™•ì¸
          if git rev-parse "$TARGET_VERSION" >/dev/null 2>&1; then
            echo "âœ… Target version $TARGET_VERSION exists in Git"
            echo "version=$TARGET_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ Target version $TARGET_VERSION not found in Git"
            exit 1
          fi
          
          # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
          if docker manifest inspect "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TARGET_VERSION" >/dev/null 2>&1; then
            echo "âœ… Container image exists for version $TARGET_VERSION"
          else
            echo "âŒ Container image not found for version $TARGET_VERSION"
            exit 1
          fi

      - name: ë¡¤ë°± ìŠ¹ì¸ ê²€ì¦
        id: approval
        run: |
          ENVIRONMENT="${{ inputs.target_environment }}"
          SKIP_VALIDATION="${{ inputs.skip_validation }}"
          
          if [[ "$ENVIRONMENT" == "production" ]] && [[ "$SKIP_VALIDATION" != "true" ]]; then
            echo "ğŸš¨ Production rollback requires manual approval"
            echo "approved=false" >> $GITHUB_OUTPUT
            
            # GitHub Issue ìƒì„±ìœ¼ë¡œ ìŠ¹ì¸ ìš”ì²­
            gh issue create \
              --title "ğŸ”„ Production Rollback Approval Required" \
              --body "**Rollback Request**
            
            - **Environment**: $ENVIRONMENT
            - **Current Version**: ${{ steps.current.outputs.version }}
            - **Target Version**: ${{ inputs.rollback_to }}
            - **Reason**: ${{ inputs.reason }}
            - **Requested by**: ${{ github.actor }}
            
            **To approve this rollback:**
            1. Review the rollback plan
            2. Comment 'APPROVE' on this issue
            3. Re-run the workflow
            
            **To reject:**
            1. Comment 'REJECT' with reason
            2. Close this issue" \
              --label "rollback,production,approval-required"
            
            echo "âŒ Manual approval required for production rollback"
            exit 1
          else
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "âœ… Rollback approved"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ë¡¤ë°± ê³„íš ì¶œë ¥
        run: |
          echo "ğŸ“‹ Rollback Plan"
          echo "==============="
          echo "Environment: ${{ inputs.target_environment }}"
          echo "Current Version: ${{ steps.current.outputs.version }}"
          echo "Target Version: ${{ inputs.rollback_to }}"
          echo "Reason: ${{ inputs.reason }}"
          echo "Skip Validation: ${{ inputs.skip_validation }}"
          echo "Triggered by: ${{ github.actor }}"

  # ========================================
  # Stage 2: ë°±ì—… ìƒì„±
  # ========================================
  create-backup:
    name: ğŸ’¾ í˜„ì¬ ìƒíƒœ ë°±ì—…
    runs-on: ubuntu-latest
    needs: rollback-validation
    if: needs.rollback-validation.outputs.rollback-approved == 'true'
    
    steps:
      - name: í˜„ì¬ ë°°í¬ ìƒíƒœ ë°±ì—…
        run: |
          echo "ğŸ’¾ Creating backup of current deployment..."
          ENVIRONMENT="${{ inputs.target_environment }}"
          CURRENT_VERSION="${{ needs.rollback-validation.outputs.current-version }}"
          
          # í˜„ì¬ ë°°í¬ ì„¤ì • ë°±ì—…
          # kubectl get deployment vridge-web-$ENVIRONMENT -o yaml > backup-$CURRENT_VERSION.yaml
          
          echo "âœ… Backup created for version $CURRENT_VERSION"

      - name: ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (ì„ íƒì )
        run: |
          echo "ğŸ’¾ Creating database backup (if needed)..."
          
          # í•„ìš”ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
          # pg_dump $DATABASE_URL > db-backup-$(date +%Y%m%d%H%M%S).sql
          
          echo "âœ… Database backup completed"

      - name: ë°±ì—… ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: rollback-backup-${{ needs.rollback-validation.outputs.current-version }}
          path: backup-*
          retention-days: 30

  # ========================================
  # Stage 3: ë¡¤ë°± ì‹¤í–‰
  # ========================================
  execute-rollback:
    name: ğŸ”„ ë¡¤ë°± ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: [rollback-validation, create-backup]
    environment: ${{ inputs.target_environment }}
    
    steps:
      - name: ë¡¤ë°± ì‹œì‘ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ”„ Rollback started",
              "attachments": [{
                "color": "warning",
                "fields": [{
                  "title": "Environment",
                  "value": "${{ inputs.target_environment }}",
                  "short": true
                }, {
                  "title": "From â†’ To",
                  "value": "${{ needs.rollback-validation.outputs.current-version }} â†’ ${{ inputs.rollback_to }}",
                  "short": true
                }, {
                  "title": "Reason",
                  "value": "${{ inputs.reason }}",
                  "short": false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ë¡¤ë°± ëŒ€ìƒ ì´ë¯¸ì§€ ê²€ì¦
        run: |
          TARGET_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.rollback_to }}"
          
          # ì´ë¯¸ì§€ ì¡´ì¬ ë° ë¬´ê²°ì„± í™•ì¸
          docker pull "$TARGET_IMAGE"
          docker inspect "$TARGET_IMAGE"
          
          echo "âœ… Target image verified: $TARGET_IMAGE"

      - name: ë°°í¬ ë¡¤ë°± ì‹¤í–‰
        run: |
          echo "ğŸ”„ Rolling back deployment..."
          ENVIRONMENT="${{ inputs.target_environment }}"
          TARGET_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.rollback_to }}"
          
          # Kubernetes ë¡¤ë°±
          # kubectl set image deployment/vridge-web-$ENVIRONMENT vridge-web=$TARGET_IMAGE
          
          # ë˜ëŠ” Docker Swarm ë¡¤ë°±
          # docker service update --image $TARGET_IMAGE vridge-web-$ENVIRONMENT
          
          # ë˜ëŠ” Vercel ë¡¤ë°±
          # vercel --prod --token=$VERCEL_TOKEN
          
          echo "âœ… Deployment rollback completed"

      - name: ë¡¤ë°± í›„ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ” Running post-rollback health checks..."
          ENVIRONMENT="${{ inputs.target_environment }}"
          
          if [[ "$ENVIRONMENT" == "production" ]]; then
            HEALTH_URL="https://vridge.vlanet.net/api/health"
          else
            HEALTH_URL="https://staging.vridge.vlanet.net/api/health"
          fi
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
          for i in {1..60}; do
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "âœ… Application is healthy after rollback"
              break
            fi
            echo "â³ Waiting for application to start... ($i/60)"
            sleep 10
          done
          
          # ë²„ì „ í™•ì¸
          DEPLOYED_VERSION=$(curl -s "$HEALTH_URL" | jq -r '.version' || echo "unknown")
          if [[ "$DEPLOYED_VERSION" == "${{ inputs.rollback_to }}" ]]; then
            echo "âœ… Rollback version confirmed: $DEPLOYED_VERSION"
          else
            echo "âŒ Rollback verification failed. Expected: ${{ inputs.rollback_to }}, Got: $DEPLOYED_VERSION"
            exit 1
          fi

      - name: ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ§ª Running post-rollback smoke tests..."
          ENVIRONMENT="${{ inputs.target_environment }}"
          
          # í™˜ê²½ë³„ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          if [[ "$ENVIRONMENT" == "production" ]]; then
            npx playwright test --config=playwright.production.config.ts --project=production-smoke
          else
            npx playwright test --config=playwright.staging.config.ts --project=staging-smoke
          fi
          
          echo "âœ… Post-rollback smoke tests passed"

  # ========================================
  # Stage 4: ë¡¤ë°± ê²€ì¦ ë° ëª¨ë‹ˆí„°ë§
  # ========================================
  rollback-verification:
    name: âœ… ë¡¤ë°± ê²€ì¦ ë° ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: [rollback-validation, execute-rollback]
    
    steps:
      - name: ë¡¤ë°± í›„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        run: |
          echo "ğŸ“Š Collecting post-rollback metrics..."
          
          # 5ë¶„ê°„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ëŒ€ê¸°
          sleep 300
          
          # ì—ëŸ¬ìœ¨ í™•ì¸
          ERROR_RATE=$(curl -s https://metrics.vlanet.net/api/error-rate/5m || echo "0")
          RESPONSE_TIME=$(curl -s https://metrics.vlanet.net/api/response-time/5m || echo "0")
          
          echo "Post-rollback metrics:"
          echo "Error Rate: ${ERROR_RATE}%"
          echo "Response Time: ${RESPONSE_TIME}ms"
          
          # ë©”íŠ¸ë¦­ ì„ê³„ê°’ ê²€ì‚¬
          if (( $(echo "$ERROR_RATE > 2" | bc -l) )); then
            echo "âš ï¸ High error rate after rollback: ${ERROR_RATE}%"
          fi

      - name: ì‚¬ìš©ì ì˜í–¥ í‰ê°€
        run: |
          echo "ğŸ‘¥ Assessing user impact..."
          
          # í™œì„± ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸
          # ì‹¤ì œë¡œëŠ” APM ë„êµ¬ë‚˜ ë¶„ì„ ë„êµ¬ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
          
          echo "âœ… User impact assessment completed"

      - name: ë¡¤ë°± ì„±ê³µ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: success
          text: |
            ğŸ‰ Rollback completed successfully!
            
            Environment: ${{ inputs.target_environment }}
            Version: ${{ needs.rollback-validation.outputs.current-version }} â†’ ${{ inputs.rollback_to }}
            Reason: ${{ inputs.reason }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ë¡¤ë°± ì‹¤íŒ¨ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: failure
          text: |
            ğŸš¨ Rollback failed!
            
            Environment: ${{ inputs.target_environment }}
            Target Version: ${{ inputs.rollback_to }}
            
            Manual intervention required!
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ë¡¤ë°± ê¸°ë¡ ì—…ë°ì´íŠ¸
        if: always()
        run: |
          echo "ğŸ“ Updating rollback records..."
          
          STATUS=${{ job.status }}
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # ë¡¤ë°± ê¸°ë¡ì„ ë°ì´í„°ë² ì´ìŠ¤ë‚˜ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì— ì €ì¥
          echo "Rollback record:"
          echo "- Environment: ${{ inputs.target_environment }}"
          echo "- From: ${{ needs.rollback-validation.outputs.current-version }}"
          echo "- To: ${{ inputs.rollback_to }}"
          echo "- Status: $STATUS"
          echo "- Timestamp: $TIMESTAMP"
          echo "- Reason: ${{ inputs.reason }}"
          echo "- Triggered by: ${{ github.actor }}"