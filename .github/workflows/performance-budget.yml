name: Performance Budget Enforcement
# Core Web Vitals μμ‚° μ„λ° μ‹ PR μ°¨λ‹¨

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  performance-budget:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build application
        run: pnpm run build
        
      - name: Start server
        run: pnpm run start &
        
      - name: Wait for server
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 1; done'
          
      - name: Run Lighthouse CI (Performance Budget)
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouserc.js'
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: Performance Budget Status
        run: |
          echo "## π― μ„±λ¥ μμ‚° κ²€μ¦ κ²°κ³Ό" >> $GITHUB_STEP_SUMMARY
          echo "- LCP λ©ν‘: β‰¤ 2.5μ΄" >> $GITHUB_STEP_SUMMARY
          echo "- CLS λ©ν‘: β‰¤ 0.1" >> $GITHUB_STEP_SUMMARY 
          echo "- INP λ©ν‘: β‰¤ 200ms" >> $GITHUB_STEP_SUMMARY
          echo "- TTI λ©ν‘: β‰¤ 3.8μ΄" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "μƒμ„Έ κ²°κ³Όλ” Lighthouse CI λ¦¬ν¬νΈλ¥Ό ν™•μΈν•μ„Έμ”." >> $GITHUB_STEP_SUMMARY
          
      # μ„±λ¥ μμ‚° μ„λ° μ‹ Slack μ•λ¦Ό (μ„ νƒμ‚¬ν•­)
      - name: Performance Budget Violation Alert
        if: failure()
        run: |
          echo "β οΈ μ„±λ¥ μμ‚° μ„λ°μ΄ κ°μ§€λμ—μµλ‹λ‹¤!"
          echo "Core Web Vitals κΈ°μ¤€μ„ μ¶©μ΅±ν•μ§€ λ»ν–μµλ‹λ‹¤."
          echo "μ„±λ¥ μµμ ν™”κ°€ ν•„μ”ν•©λ‹λ‹¤."
          exit 1