name: ğŸ›¡ï¸ Security & Error Recovery Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  schedule:
    - cron: '0 2 * * *' # ë§¤ì¼ ìƒˆë²½ 2ì‹œ ì •ê¸° ìŠ¤ìº”

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '8'

jobs:
  # ğŸ” ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
  security-scan:
    name: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”
          
      - name: ë¯¼ê°ì •ë³´ ëˆ„ì¶œ ìŠ¤ìº” (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
          
      - name: SAST ë³´ì•ˆ ë¶„ì„ (CodeQL)
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, python
          
      - name: ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
        run: |
          # Frontend ì˜ì¡´ì„± ìŠ¤ìº”
          cd vridge-web
          npm audit --audit-level high
          
          # Backend ì˜ì¡´ì„± ìŠ¤ìº”  
          cd ../vridge_back
          pip install safety
          safety check --json > safety-report.json || true
          
      - name: ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: |
            vridge_back/safety-report.json
            .trufflehog-results.json

  # ğŸ§ª ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
  error-handling-tests:
    name: ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      matrix:
        test-type: [unit, integration, e2e-error-scenarios]
        
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (Frontend)
        working-directory: ./vridge-web
        run: pnpm install --frozen-lockfile
        
      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Python ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: ./vridge_back
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ì—ëŸ¬ í•¸ë“¤ë§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'unit'
        working-directory: ./vridge-web
        run: |
          # ì—ëŸ¬ í•¸ë“¤ë§ ê´€ë ¨ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          pnpm test -- --testPathPattern="error-handling|ErrorBoundary" --coverage
          
      - name: API ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ í†µí•© í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'integration'
        working-directory: ./vridge_back
        run: |
          # Django ì—ëŸ¬ í•¸ë“¤ë§ í…ŒìŠ¤íŠ¸
          python manage.py test --pattern="*error*" --verbosity=2
          
      - name: E2E ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'e2e-error-scenarios'
        working-directory: ./vridge-web
        run: |
          # Cypressë¡œ ì—ëŸ¬ ìƒí™© E2E í…ŒìŠ¤íŠ¸
          pnpm run test:e2e:error-scenarios
          
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: error-test-results-${{ matrix.test-type }}
          path: |
            vridge-web/coverage/
            vridge-web/cypress/screenshots/
            vridge-web/cypress/videos/

  # ğŸ”§ ì•„í‚¤í…ì²˜ ê²½ê³„ ê²€ì¦
  fsd-boundary-check:
    name: FSD ì•„í‚¤í…ì²˜ ê²½ê³„ ê²€ì¦
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: ./vridge-web
        run: pnpm install --frozen-lockfile
        
      - name: ESLint FSD ê²½ê³„ ê²€ì¦
        working-directory: ./vridge-web
        run: |
          pnpm lint --format=json > eslint-fsd-report.json || true
          
      - name: ì˜ì¡´ì„± ê·¸ë˜í”„ ë¶„ì„
        working-directory: ./vridge-web
        run: |
          # ìˆœí™˜ ì˜ì¡´ì„± ë° FSD ìœ„ë°˜ ê²€ì‚¬
          npx madge --circular --format=json src/ > dependency-analysis.json || true
          
      - name: ì•„í‚¤í…ì²˜ ê²€ì¦ ê²°ê³¼ í‰ê°€
        run: |
          node -e "
            const eslintReport = require('./vridge-web/eslint-fsd-report.json');
            const fsdViolations = eslintReport.filter(result => 
              result.messages.some(msg => msg.ruleId && msg.ruleId.includes('boundary'))
            );
            
            if (fsdViolations.length > 0) {
              console.error('ğŸš¨ FSD ê²½ê³„ ìœ„ë°˜ ê°ì§€:', fsdViolations.length, 'ê±´');
              process.exit(1);
            }
            
            console.log('âœ… FSD ì•„í‚¤í…ì²˜ ê²½ê³„ ì¤€ìˆ˜ í™•ì¸ë¨');
          "
          
      - name: ì•„í‚¤í…ì²˜ ê²€ì¦ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: fsd-boundary-results
          path: |
            vridge-web/eslint-fsd-report.json
            vridge-web/dependency-analysis.json

  # ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì—ëŸ¬ ë³µêµ¬ í…ŒìŠ¤íŠ¸
  production-error-recovery:
    name: í”„ë¡œë•ì…˜ ì—ëŸ¬ ë³µêµ¬ ì‹œë®¬ë ˆì´ì…˜
    runs-on: ubuntu-latest
    needs: [security-scan, error-handling-tests, fsd-boundary-check]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    timeout-minutes: 25
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ë°°í¬ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •
        run: |
          # Docker Composeë¡œ í”„ë¡œë•ì…˜ ìœ ì‚¬ í™˜ê²½ êµ¬ì¶•
          cat > docker-compose.test.yml << 'EOF'
          version: '3.8'
          services:
            frontend:
              build:
                context: ./vridge-web
                dockerfile: Dockerfile
              ports:
                - "3000:3000"
              environment:
                - NODE_ENV=production
                - NEXT_PUBLIC_API_URL=http://backend:8000
              depends_on:
                - backend
                
            backend:
              build:
                context: ./vridge_back
                dockerfile: Dockerfile
              ports:
                - "8000:8000"
              environment:
                - DJANGO_SETTINGS_MODULE=config.settings
                - DEBUG=False
              depends_on:
                - redis
                - postgres
                
            redis:
              image: redis:7-alpine
              ports:
                - "6379:6379"
                
            postgres:
              image: postgres:15-alpine
              environment:
                POSTGRES_DB: vridge_test
                POSTGRES_USER: test
                POSTGRES_PASSWORD: test
              ports:
                - "5432:5432"
          EOF
          
      - name: í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ë™
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 30 # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
          
      - name: ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜
        run: |
          # ë‹¤ì–‘í•œ ì—ëŸ¬ ìƒí™© ì‹œë®¬ë ˆì´ì…˜
          echo "ğŸ§ª ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜"
          docker-compose -f docker-compose.test.yml stop postgres
          
          # í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ í•¸ë“¤ë§ í™•ì¸
          curl -f http://localhost:3000/health || echo "ì˜ˆìƒëœ ì—ëŸ¬ ë°œìƒ"
          
          # ë°±ì—”ë“œ ì—ëŸ¬ í•¸ë“¤ë§ í™•ì¸  
          curl -f http://localhost:8000/api/health || echo "ì˜ˆìƒëœ ì—ëŸ¬ ë°œìƒ"
          
          # ë³µêµ¬ í…ŒìŠ¤íŠ¸
          echo "ğŸ”§ ì„œë¹„ìŠ¤ ë³µêµ¬ ì‹œë®¬ë ˆì´ì…˜"
          docker-compose -f docker-compose.test.yml start postgres
          sleep 10
          
          # ë³µêµ¬ í™•ì¸
          curl -f http://localhost:3000/health && echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë³µêµ¬ í™•ì¸"
          curl -f http://localhost:8000/api/health && echo "âœ… ë°±ì—”ë“œ ë³µêµ¬ í™•ì¸"
          
      - name: ë¡œê·¸ ìˆ˜ì§‘ ë° ë¶„ì„
        if: always()
        run: |
          mkdir -p logs
          docker-compose -f docker-compose.test.yml logs frontend > logs/frontend.log
          docker-compose -f docker-compose.test.yml logs backend > logs/backend.log
          docker-compose -f docker-compose.test.yml logs redis > logs/redis.log
          docker-compose -f docker-compose.test.yml logs postgres > logs/postgres.log
          
      - name: í™˜ê²½ ì •ë¦¬
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v
          
      - name: ë³µêµ¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: production-recovery-logs
          path: logs/

  # ğŸ“Š ë³´ì•ˆ ë° ì—ëŸ¬ ì²˜ë¦¬ í’ˆì§ˆ ë¦¬í¬íŠ¸
  quality-report:
    name: í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [security-scan, error-handling-tests, fsd-boundary-check, production-error-recovery]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        
      - name: í†µí•© í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          cat > quality-report.md << 'EOF'
          # ğŸ›¡ï¸ ë³´ì•ˆ & ì—ëŸ¬ ì²˜ë¦¬ í’ˆì§ˆ ë¦¬í¬íŠ¸
          
          ## ğŸ“… ì‹¤í–‰ ì •ë³´
          - **ì¼ì‹œ**: $(date)
          - **ë¸Œëœì¹˜**: ${{ github.ref }}
          - **ì»¤ë°‹**: ${{ github.sha }}
          
          ## ğŸ” ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
          $(if [ -f security-scan-results/safety-report.json ]; then
            echo "### Python ì˜ì¡´ì„± ë³´ì•ˆ"
            python -c "
          import json
          with open('security-scan-results/safety-report.json', 'r') as f:
              data = json.load(f)
              if data:
                  print(f'âš ï¸ ì·¨ì•½ì  {len(data)}ê±´ ë°œê²¬')
                  for vuln in data[:3]:  # ìƒìœ„ 3ê°œë§Œ í‘œì‹œ
                      print(f'- {vuln.get(\"vulnerability\", \"Unknown\")}: {vuln.get(\"package_name\", \"Unknown\")}')
              else:
                  print('âœ… ë³´ì•ˆ ì·¨ì•½ì  ì—†ìŒ')
          "
          else
            echo "ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—†ìŒ"
          fi)
          
          ## ğŸ§ª ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          - **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: $([ -d error-test-results-unit ] && echo "í†µê³¼" || echo "ì‹¤íŒ¨")
          - **í†µí•© í…ŒìŠ¤íŠ¸**: $([ -d error-test-results-integration ] && echo "í†µê³¼" || echo "ì‹¤íŒ¨")  
          - **E2E í…ŒìŠ¤íŠ¸**: $([ -d error-test-results-e2e-error-scenarios ] && echo "í†µê³¼" || echo "ì‹¤íŒ¨")
          
          ## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê²€ì¦ ê²°ê³¼
          $(if [ -f fsd-boundary-results/eslint-fsd-report.json ]; then
            echo "### FSD ê²½ê³„ ì¤€ìˆ˜"
            node -e "
          const report = require('./fsd-boundary-results/eslint-fsd-report.json');
          const violations = report.filter(r => 
            r.messages.some(m => m.ruleId && m.ruleId.includes('boundary'))
          ).length;
          
          if (violations === 0) {
            console.log('âœ… FSD ì•„í‚¤í…ì²˜ ê²½ê³„ ì¤€ìˆ˜');
          } else {
            console.log(\`âš ï¸ FSD ê²½ê³„ ìœ„ë°˜ \${violations}ê±´\`);
          }
          "
          else
            echo "ì•„í‚¤í…ì²˜ ê²€ì¦ ê²°ê³¼ ì—†ìŒ"
          fi)
          
          ## ğŸš€ í”„ë¡œë•ì…˜ ë³µêµ¬ ì‹œë®¬ë ˆì´ì…˜
          $([ -d production-recovery-logs ] && echo "âœ… ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ" || echo "âŒ ë³µêµ¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨")
          
          ## ğŸ“ˆ ê¶Œì¥ì‚¬í•­
          - ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬ ì‹œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ í•„ìš”
          - ì—ëŸ¬ í•¸ë“¤ë§ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì½”ë“œ ê°œì„  í•„ìš”
          - FSD ê²½ê³„ ìœ„ë°˜ ì‹œ ì•„í‚¤í…ì²˜ ë¦¬íŒ©í† ë§ í•„ìš”
          - ë³µêµ¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ìš´ì˜ ì ˆì°¨ ì ê²€ í•„ìš”
          
          EOF
          
      - name: í’ˆì§ˆ ë¦¬í¬íŠ¸ë¥¼ PRì— ì½”ë©˜íŠ¸
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
            
      - name: í’ˆì§ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: quality-report
          path: quality-report.md

  # ğŸš¨ ê¸´ê¸‰ ì•Œë¦¼
  emergency-notification:
    name: ê¸´ê¸‰ ë³´ì•ˆ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Slack ê¸´ê¸‰ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security-alerts'
          text: |
            ğŸš¨ CRITICAL: ë³´ì•ˆ ì·¨ì•½ì  ë˜ëŠ” ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ ì¥ì•  ê°ì§€
            
            - ë¸Œëœì¹˜: ${{ github.ref }}
            - ì»¤ë°‹: ${{ github.sha }}
            - ì‘ì—…ì: ${{ github.actor }}
            
            ì¦‰ì‹œ í™•ì¸ ë° ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤!
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}