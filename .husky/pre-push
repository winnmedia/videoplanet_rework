#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” í‘¸ì‹œ ì „ í’ˆì§ˆ ê²€ì‚¬..."

# ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ê²€ì‚¬
echo "ğŸ§ª ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰..."
npm run test:coverage

# ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ í™•ì¸ (80% ì´ìƒ ê°•ì œ)
echo "ğŸ“Š ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì¦..."
node -e "
const fs = require('fs');
try {
  const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
  const { lines, functions, branches, statements } = coverage.total;
  
  const thresholds = { lines: 80, functions: 80, branches: 80, statements: 80 };
  const failures = [];
  
  Object.entries(thresholds).forEach(([metric, threshold]) => {
    const actual = coverage.total[metric].pct;
    if (actual < threshold) {
      failures.push(\`\${metric}: \${actual}% < \${threshold}%\`);
    }
  });
  
  if (failures.length > 0) {
    console.error('âŒ ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ë¯¸ë‹¬:');
    failures.forEach(failure => console.error(\`  - \${failure}\`));
    process.exit(1);
  }
  
  console.log('âœ… ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ í†µê³¼');
} catch (error) {
  console.error('âŒ ì»¤ë²„ë¦¬ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
  process.exit(1);
}
"

# ë¹Œë“œ ê²€ì¦
echo "ğŸ—ï¸  ë¹Œë“œ ê²€ì¦..."
npm run build

echo "âœ… í‘¸ì‹œ ì „ ê²€ì‚¬ ì™„ë£Œ"