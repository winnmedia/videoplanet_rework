#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 푸시 전 품질 검사..."

# 전체 테스트 실행 및 커버리지 검사
echo "🧪 전체 테스트 스위트 실행..."
npm run test:coverage

# 커버리지 임계값 확인 (80% 이상 강제)
echo "📊 커버리지 임계값 검증..."
node -e "
const fs = require('fs');
try {
  const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
  const { lines, functions, branches, statements } = coverage.total;
  
  const thresholds = { lines: 80, functions: 80, branches: 80, statements: 80 };
  const failures = [];
  
  Object.entries(thresholds).forEach(([metric, threshold]) => {
    const actual = coverage.total[metric].pct;
    if (actual < threshold) {
      failures.push(\`\${metric}: \${actual}% < \${threshold}%\`);
    }
  });
  
  if (failures.length > 0) {
    console.error('❌ 커버리지 임계값 미달:');
    failures.forEach(failure => console.error(\`  - \${failure}\`));
    process.exit(1);
  }
  
  console.log('✅ 커버리지 임계값 통과');
} catch (error) {
  console.error('❌ 커버리지 파일을 찾을 수 없습니다. 먼저 테스트를 실행하세요.');
  process.exit(1);
}
"

# 빌드 검증
echo "🏗️  빌드 검증..."
npm run build

echo "✅ 푸시 전 검사 완료"